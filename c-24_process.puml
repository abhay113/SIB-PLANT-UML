@startuml

participant ESB
Database "DB" as DB
Queue "MQ" as MQ
Database "Extenal DB" as FN

DB -> MQ : DB Trigger puts the Message in the MQ (PAYHUB.C24.SEND.IN)
MQ --> ESB : Returns the Message

ESB -> ESB : If mandatory fields are missing Throw Exception "Mandatory fields are not present"

ESB -> MQ: If LogReq = "Y" send message to EAI.MSGLOG.MGT.IN queue
MQ --> ESB: message inserted

ESB -> DB : Fetch XML payload from INWARD_TRN table based on TRANSACTION_ID
DB --> ESB : Returns data

ESB -> DB : Fetch SENDER_REF from TRANSACTION_PAYLOAD and INWARD_TRN table based on TRANSACTION_ID
DB --> ESB : Returns data

ESB -> DB : Fetch STS_LKP_CD from INWARD_TRN table based on TRANSACTION_ID
DB --> ESB : Returns data

ESB -> ESB : Convert the Data into BLOB format

alt UPDT_MSG_BLOB is NULL
    ESB -> ESB : Throw Exception "Status of Message is Invalid"
end

ESB -> ESB : Convert the Data into XMLNSC format

alt STS_LKP_CODE = 'CK_VERIFIED'
    ESB -> ESB : Update the TRANSACTION_PAYLOAD table with new XML payload
    DB --> ESB : returns update status
    alt SQLCODE <> 0 
        ESB -> ESB : Throw Exception "Failed to update IFSC code to database"
    end
end

alt TRANSACTION_TYPE = 'T'
' --code here
else 
    ESB -> DB : Fetch GET_LKPCD(HOST_TYPE_LKP_ID) as HOST from EXCHANGE_HOUSE_MASTER and SENDER_MASTER 
    DB --> ESB : Returns Data
    ESB -> DB : Fetch LAST_ERR_CODE AND LAST_ERR_TEXT from INWARD_TXN
    DB --> ESB : Returns Data


    alt LAST_ERR_CD = 'FCRA001' and LAST_ERR_TXT = 'FCRA Restricted Foreign Donors'
end
' --------------------------------------------------- not able to get this

' validation stars here 

alt ISO_MSG_TYPE is NULL 
    ESB -> ESB : Throw Error 'ISO Validation Failed : MessageType not Found'    
else ISO_MSG_TYPE != 4 
    ESB -> ESB : Throw Error 'ISO Validation Failed : MessageType should be 4 digit'
end


ESB -> ESB : if ISO_TRANSACTION_TYPE is NULL or length of ISO_TRANSACTION_TYPE <2 then Throw Error 'ISO Validation Failed : TansactionTpye not found'

ESB -> ESB : if SystemTraceAuditNumber is NULL Or < 1  Throw Error 'ISO Validation Failed : STANID not found'

ESB -> ESB : if Transaction_Amount <= 0  then  Throw Error 'ISO Validation Failed : Amount Cannot be less than  0'

alt TransactionCurrencyCode is NULL    
    ESB -> ESB : Throw Error 'ISO Validation Failed : Country Code not found'
else length of TransactionCurrencyCode != 3     
     ESB -> ESB : Throw Error 'ISO Validation Failed :  Currency Code should be of THREE characters'
end

alt length of AccountIdentification1 = 0
    ESB -> ESB : Throw Error 'ISO Validation Failed : First Account Activation code not found'
else length of AccountIdentification1 !=38
    ESB -> ESB : Throw Error 'ISO Validation Failed : First Account Activation code should be 38 characters'
end

alt length of AccountIdentification2 = 0
    ESB -> ESB : Throw Error 'ISO Validation Failed : Second Account Activation code not found'
else length of AccountIdentification1 !=40
    ESB -> ESB : Throw Error 'ISO Validation Failed : Second Account Activation code should be 40 characters'
end

alt DeliveryChannelControllerId is NULL 
    ESB -> ESB : Throw Error 'ISO Validation Failed : Delivery Channel Controller ID  not found.'
else length of DeliveryChannelControllerId != 3
    ESB -> ESB : Throw Error 'ISO Validation Failed : Delivery Channel Controller ID should be of 3 characters'
end



@enduml
